---
import Layout from "../../../layouts/Layout.astro"

export const prerender = false;

const {id} = Astro.params;

// Traitement du formulaire
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        
        const data = {
            nom: formData.get("nom"),
            prenom: formData.get("prenom"),
            naissance: formData.get("naissance") || null,
            mort: formData.get("mort") || null,
            profession: formData.getAll("profession"),
            nationalite: formData.get("nationalite") || null,
            user: Astro.locals.pb.authStore.model?.id
        };

        // Créer la personne dans PocketBase
        const record = await Astro.locals.pb.collection('Personnes').create(data);
        
        // Rediriger vers la page de la personne créée
        return Astro.redirect(`/personne/${record.id}-${record.nom?.toLowerCase().replace(/\s+/g, '-') || 'personne'}`);
        
    } catch (error) {
        console.error("Erreur lors de la création:", error);
    }
}
---

<Layout>
    <div class="max-w-2xl mx-auto p-6">
        <h1 class="text-3xl font-bold mb-6">Créer une fiche acteur</h1>
        <form method="post" class="space-y-6">
            <div>
                <label for="nom" class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                <input id="nom" name="nom" type="text" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div>
                <label for="prenom" class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
                <input id="prenom" name="prenom" type="text" required 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="naissance" class="block text-sm font-medium text-gray-700 mb-2">Date de naissance</label>
                    <input id="naissance" name="naissance" type="date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
                <div>
                    <label for="mort" class="block text-sm font-medium text-gray-700 mb-2">Date de décès</label>
                    <input id="mort" name="mort" type="date" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                </div>
            </div>
            <div>
                <label for="profession" class="block text-sm font-medium text-gray-700 mb-2">Profession</label>
                <select id="profession" name="profession" multiple 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 h-32">
                    <option value="acteur">Acteur</option>
                    <option value="réalisateur">Réalisateur</option>
                    <option value="scénariste">Scénariste</option>
                    <option value="producteur">Producteur</option>
                </select>
                <p class="mt-1 text-sm text-gray-500">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs options</p>
            </div>
            <div>
                <label for="nationalite" class="block text-sm font-medium text-gray-700 mb-2">Nationalité</label>
                <select id="nationalite" name="nationalite" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">- Select -</option>
                    <option value="fr">fr</option>
                    <option value="us">us</option>
                    <option value="uk">uk</option>
                </select>
            </div>
            <div class="flex gap-4">
                <button type="submit" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">
                    Enregistrer
                </button>
                <a href="/personne/" 
                   class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md transition duration-300 inline-block">
                    Annuler
                </a>
            </div>
        </form>
    </div>
</Layout>