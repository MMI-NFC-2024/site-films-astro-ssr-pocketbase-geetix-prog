---
import slug from "slug";
import Layout from "../../../layouts/Layout.astro"
import type { FilmsResponse } from "../../../pocketbase-types";
import { formatDate } from "../../../utilitaires";
const { id } = Astro.params ;
let message = null
let film = {} as FilmsResponse ;
if (id) {
    film = await Astro.locals.pb.collection("Films").getOne(id)
}

// Récupérer toutes les personnes pour le select
const personnes = await Astro.locals.pb.collection("Personnes").getFullList({
    sort: "nom"
});

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const filmCree = await (id
            ?(Astro.locals.pb.collection("Films").update(id!, data))
            :(Astro.locals.pb.collection("Films").create(data))
        )
        .catch(err => {
            console.error("Erreur de sauvegarde du film : ", err);
            message = err.message ;
            return null
        })
    ;
    if (filmCree) {
        return Astro.redirect(`/film/${filmCree.id}-${slug(filmCree.titre ?? "Inconnu")}`)
    }
}
---

<Layout>
    <h1>{ id ? "Modifier un film" : "Ajouter un film" }</h1>
    {message && <p class="text-red-500">{message}</p>}
    <form method="post">

        { id && <input type="hidden" name="id" value={id}> }

        <input type="hidden" name="user" value={Astro.locals.pb.authStore.record?.id}>

        <label class="block">
                <span class="text-gray-700">Titre :</span>
                <input name="titre" value={film.titre} type="text" class="mt-1 block w-full" placeholder="">
        </label>

        <label class="block">
                <span class="text-gray-700">Date de sortie :</span>
                <input name="sortie" value={formatDate(film.sortie)} type="date" class="mt-1 block w-full" placeholder="">
        </label>

        <label class="block">
                <span class="text-gray-700">Durée (en minutes) :</span>
                <input name="duree" value={film.duree} type="number" class="mt-1 block w-full" placeholder="">
        </label>

        <label class="block">
                <span class="text-gray-700">Synopsis :</span>
                <textarea name="synopsis" class="mt-1 block w-full" rows="4">{film.synopsis}</textarea>
        </label>

        <label class="block">
                <span class="text-gray-700">Acteurs :</span>
                <select name="personnes" multiple class="mt-1 block w-full" size="5">
                    {personnes.map((personne) => (
                        <option 
                            value={personne.id} 
                            selected={film.personnes?.includes(personne.id)}
                        >
                            {personne.prenom} {personne.nom}
                        </option>
                    ))}
                </select>
                <span class="text-sm text-gray-500">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs acteurs</span>
        </label>

        <button>
            { id ? "Mettre à jour" : "Ajouter" }
        </button>

    </form>
</Layout>