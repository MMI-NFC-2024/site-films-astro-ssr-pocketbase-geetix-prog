---
import slug from "slug";
import Layout from "../../../layouts/Layout.astro"
import type { FilmsResponse } from "../../../pocketbase-types";
import { formatDate } from "../../../utilitaires";
const { id } = Astro.params ;
let message = null
let film = {} as FilmsResponse ;
if (id) {
    film = await Astro.locals.pb.collection("Films").getOne(id)
}

const imageUrl = film.image ? Astro.locals.pb.files.getURL(film, film.image) : null;

const personnes = await Astro.locals.pb.collection("Personnes").getFullList({
    sort: "nom"
});

const personnesList = await Astro.locals.pb.collection("Personnes").getFullList();

if (Astro.request.method === "POST") {
    const data = await Astro.request.formData();
    const filmCree = await (id
            ?(Astro.locals.pb.collection("Films").update(id!, data))
            :(Astro.locals.pb.collection("Films").create(data))
        )
        .catch(err => {
            console.error("Erreur de sauvegarde du film : ", err);
            message = err.message ;
            return null
        })
    ;
    if (filmCree) {
        return Astro.redirect(`/film/${filmCree.id}-${slug(filmCree.titre ?? "Inconnu")}`)
    }
}
---

<Layout>
    <h1>{ id ? "Modifier un film" : "Ajouter un film" }</h1>
    {message && <p class="text-red-500">{message}</p>}
    <form method="post" enctype="multipart/form-data" class="space-y-4">

        { id && <input type="hidden" name="id" value={id}> }

        <input type="hidden" name="user" value={Astro.locals.pb.authStore.record?.id}>

        <div class="flex items-center gap-4">
            <label for="titre" class="text-gray-700 w-40">Titre :</label>
            <input id="titre" name="titre" value={film.titre} type="text" class="flex-1">
        </div>

        <div class="flex items-center gap-4">
            <label for="sortie" class="text-gray-700 w-40">Date de sortie :</label>
            <input id="sortie" name="sortie" value={formatDate(film.sortie)} type="date" class="flex-1">
        </div>

        <div class="flex items-center gap-4">
            <label for="duree" class="text-gray-700 w-40">Durée (min) :</label>
            <input id="duree" name="duree" value={film.duree} type="number" class="flex-1">
        </div>

        <div class="flex items-start gap-4">
            <label for="synopsis" class="text-gray-700 w-40 pt-2">Synopsis :</label>
            <textarea id="synopsis" name="synopsis" class="flex-1" rows="4">{film.synopsis}</textarea>
        </div>

        <div class="flex items-start gap-4">
            <label for="image" class="text-gray-700 w-40 pt-2">Image :</label>
            <div class="flex-1">
                <input id="image" name="image" type="file" accept="image/*">
                {imageUrl && (
                    <div class="mt-2">
                        <span class="text-sm text-gray-500">Image actuelle :</span>
                        <img src={imageUrl} alt={film.titre} class="mt-1 max-w-xs rounded-lg">
                    </div>
                )}
            </div>
        </div>

        <div class="flex items-start gap-4">
            <label for="personnes" class="text-gray-700 w-40 pt-2">Acteurs :</label>
            <div class="flex-1">
                <select id="personnes" name="personnes" multiple size="5" class="w-full">
                    {personnes.map((personne) => (
                        <option 
                            value={personne.id} 
                            selected={film.personnes?.includes(personne.id)}
                        >
                            {personne.prenom} {personne.nom}
                        </option>
                    ))}
                </select>
                <span class="text-sm text-gray-500">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs acteurs</span>
            </div>
        </div>

        <div class="flex items-start gap-4">
            <label for="personnes" class="text-gray-700 w-40 pt-2">Acteurs :</label>
            <div class="flex-1">
                <select id="personnes" name="personnes" multiple size="5" class="w-full">
                    {personnesList.map(({nom,prenom,id}) => (
                        <option 
                            selected={film.producteur?.includes(id)}
                            value={id} 
                        >
                            {prenom} {nom}
                        </option>
                    ))}
                </select>
                <span class="text-sm text-gray-500">Maintenez Ctrl (ou Cmd) pour sélectionner plusieurs acteurs</span>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="w-40"></div>
            <button>
                { id ? "Mettre à jour" : "Ajouter" }
            </button>
        </div>

    </form>
</Layout>